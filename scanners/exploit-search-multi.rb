require 'nmap/program'

#time = Time.new
#t = time.strftime("%Y-%m-%d-%H:%M:%S")
#report = '../reports/nmapscan_' + t.to_s + '_exploitsearch' + '.xml'
puts "############################"
puts "#        Ruby-recon        #"
puts "############################"
puts ""
#puts "Report name: #{report}"
ports = 1-65535 #add port here. Use array when setting multiple ports
reports = []
targets=File.open(ARGV[0]).read
targets.each_line do |ip|

  puts "Scanning ip: #{ip}"
  time = Time.new
  t = time.strftime("%Y-%m-%d-%H:%M:%S")
  ip_address = ip.strip
  report = '../reports/nmapscan_' + t.to_s + "_#{ip_address}_" + 'exploitsearch' + '.xml'
  puts "Report name: #{report}"

  Nmap::Program.scan do |nmap|
    nmap.targets = ip
    nmap.ports = ports
    nmap.connect_scan = false
    nmap.udp_scan = false
    nmap.service_scan = true
    nmap.disable_dns = false
    nmap.aggressive_timing = true
    nmap.verbose = true
    nmap.script = 'banner'
    nmap.xml = report
  end
  reports << report
end

reports.each do |report|

   puts ""
   puts "################################"
   puts "#    Searching for exploits    #"
   puts "################################"
   puts ""
   puts "Running: searchsploit --nmap #{report}"
   system "searchsploit --nmap #{report}"
end
